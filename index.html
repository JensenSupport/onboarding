<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Jensen Tire & Auto Onboarding</title>
  <link rel="stylesheet" href="shared-style.css" />
</head>
<body>

<header>
  <img src="logo.jpg" alt="Jensen Tire & Auto Logo">
  <div id="hamburger" onclick="toggleMenu()">‚ò∞</div>
</header>

<nav id="nav-menu">
  <a href="../index.html">Main Dashboard</a>
  <a href="#" onclick="openFeedbackPopup()">Submit Feedback</a>
  <a href="#" class="nav-link open-zammad-chat">Jensen Support chat</a>
  <a href="https://jensentireandauto.com" target="_blank">Retail Site</a>
</nav>
  
<div class="snap-container">
  <section id="onboarding">
    <div class="container">
      <h1>Welcome to Jensen Tire & Auto Onboarding</h1>
      <p class="subheading">Sign in with your username & password. We‚Äôll route you to the right store and position</p>

    <div class="entry">
      <div class="card stack" id="loginCard">
        <label class="muted">Username</label>
        <input id="username" placeholder="e.g. bcobb" autocomplete="username">
        <label class="muted">Password</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        <div>
          <button id="signIn">Sign in</button>
        </div>
        <p class="muted">Need access or forgot your password? Contact
          <a href="mailto:support@jensentireandauto.com">Jensen Support</a>.
        </p>
        <pre id="status" class="hidden"></pre>
      </div>

  <div class="card stack hidden" id="signedInBox">
    <p id="signedInText">Signed in as <strong id="who"></strong></p>
    <div class="actions">
      <button id="continueBtn">Continue to my training</button>
      <button id="signOutBtn">Sign out</button>
    </div>
  </div>

      <footer>
        FAQs below. Further questions? Contact
        <a href="mailto:support@jensentireandauto.com">Jensen Support</a>
      </footer>
    </div>
  </section>
</div>
</div>
  
<section id="details" class="tall-section">
  <div class="container accordion">
    <h2>New Hire FAQ</h2>
    <div class="accordion-item">
      <button onclick="toggleAccordion(this)">Do I have login information already?</button>
      <div class="accordion-content">Your manager or IT will provide a username and temporary password. Sign in above.</div>
    </div>
    <div class="accordion-item">
      <button onclick="toggleAccordion(this)">How do I access training materials?</button>
      <div class="accordion-content">After sign-in, choose ‚ÄúContinue to my hub.‚Äù We‚Äôll send you to your store‚Äôs role page.</div>
    </div>
    <div class="accordion-item">
      <button onclick="toggleAccordion(this)">Who do I contact with issues?</button>
      <div class="accordion-content">Reach out to Jensen Support at support@jensentireandauto.com.</div>
    </div>
  </div>

  <div class="container feedback-section">
    <h1>We value your input!</h1>
    <form id="feedback-form">
      <textarea id="feedback" name="feedback" placeholder="Leave your feedback here..."></textarea>
      <br />
      <button type="submit" class="button">Submit</button>
    </form>
    <p id="thank-you" style="display:none; color:white; margin-top:20px;">Thank you for your feedback!</p>
  </div>

  <div class="quote-footer">
    <p class="quote">‚ÄúAnyone who stops learning is old, whether at twenty or eighty. Anyone who keeps learning stays young.‚Äù</p>
    <p class="quote-author">‚Äì Henry Ford</p>
  </div>
</section>

<!-- Helpers -->
<script>
  function toggleAccordion(button) {
    const content = button.nextElementSibling;
    const isOpen = content.style.display === 'block';
    document.querySelectorAll('.accordion-content').forEach(el => el.style.display = 'none');
    if (!isOpen) content.style.display = 'block';
  }
</script>

<script>
function openFeedbackPopup() {
  document.getElementById('feedbackPopup').style.display = 'block';
}

function closeFeedbackPopup() {
  document.getElementById('feedbackPopup').style.display = 'none';
}

document.getElementById("feedback-form").addEventListener("submit", async function (e) {
  e.preventDefault();
  const feedback = document.getElementById("feedback").value;

  const response = await fetch("https://default4e006550b51242c29ec2b301c0fa6a.51.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/5a8c354b3a634ab893a5879f150f715d/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Jr-fRt0XwxxcfPUPvbpjS-xwfZlb2rjb4J_L2xwhXFg", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ feedback })
  });

  if (response.ok) {
    document.getElementById("feedback").value = "";
    document.getElementById("thank-you").style.display = "block";
    setTimeout(() => {
      document.getElementById("thank-you").style.display = "none";
      closeFeedbackPopup();
    }, 2000);
  } else {
    alert("Submission failed. Please try again.");
  }
});

</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ===== 1) YOUR FIREBASE CONFIG =====
  const firebaseConfig = {
    apiKey: "AIzaSyC3clH2uoqhgqeEwj-uOlsNT5XTZHsI2W0",
    authDomain: "user-creds.firebaseapp.com",
    projectId: "user-creds",
    appId: "1:253655292974:web:f066f853ef2f3dd7f5d3bf"
  };

  // ===== 2) SETTINGS =====
  const FAKE_DOMAIN = "jta.local"; // domain you used in Auth (username@jta.local)

  // ===== 3) INIT =====
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // UI helpers
  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const loginCard = $("loginCard");
  const signedInBox = $("signedInBox");

  function showStatus(obj) {
    statusEl.classList.remove("hidden");
    statusEl.textContent = JSON.stringify(obj, null, 2);
  }
  function destFor({ storeNumber, role }) {
    const folder = encodeURIComponent(storeNumber);
    const page = (String(role).toLowerCase() === "manager") ? "manager.html" : "technician.html";
    return `${folder}/${page}`;
  }
  async function getAssignment(email) {
    const dirRef = doc(db, "directory", email.toLowerCase());
    const dirSnap = await getDoc(dirRef);
    if (!dirSnap.exists()) throw new Error("No assignment found for your username. Contact support.");
    return dirSnap.data(); // { storeNumber, role }
  }

  // SIGN IN (username + password mapped to fake email)
  $("signIn").onclick = async () => {
    const uname = $("username").value.trim().toLowerCase();
    const pw = $("password").value;
    if (!uname || !pw) return showStatus({ error: "Enter username and password." });
    try {
      const email = `${uname}@${FAKE_DOMAIN}`;
      await signInWithEmailAndPassword(auth, email, pw);
      // onAuthStateChanged will run after sign-in
    } catch (e) {
      showStatus({ error: e.message });
    }
  };

  // AUTH STATE CHANGE: check if it's first-time sign-in and send webhook
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // signed out ‚Üí show login
      loginCard.classList.remove("hidden");
      signedInBox.classList.add("hidden");
      statusEl.classList.add("hidden");
      return;
    }

    try {
      const email = (user.email || "").toLowerCase();
      const assign = await getAssignment(email);

      // Show signed-in panel
      $("who").textContent = email.includes("@") ? email.split("@")[0] : email;
      loginCard.classList.add("hidden");
      signedInBox.classList.remove("hidden");

      $("continueBtn").onclick = () => {
        window.location.href = destFor(assign);
      };
      $("signOutBtn").onclick = async () => {
        await signOut(auth);
        window.location.href = window.location.pathname;
      };

      // ===== ‚úÖ FIRST-TIME SIGN-IN CHECK + NOTIFY POWER AUTOMATE =====
      const profRef = doc(db, "profiles", user.uid);
      const profSnap = await getDoc(profRef);
      if (!profSnap.exists()) {
        // Save new profile to Firestore
        await setDoc(profRef, {
          fakeEmail: email,
          createdAt: new Date().toISOString()
        }, { merge: true });

        // üîî Send webhook to Power Automate
        try {
          await fetch("https://your-power-automate-url-here", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              username: email.split("@")[0],
              email: email,
              signedInAt: new Date().toISOString()
            })
          });
        } catch (err) {
          console.warn("Power Automate webhook failed:", err);
        }
      }
    } catch (e) {
      await signOut(auth);
      loginCard.classList.remove("hidden");
      signedInBox.classList.add("hidden");
      showStatus({ error: e.message });
    }
  });
</script>


<script>
  function toggleMenu() {
    const menu = document.getElementById("nav-menu");
    menu.classList.toggle("open");
  }

function closeMenu() {
    const menu = document.getElementById("nav-menu");
    menu.classList.remove("open");
  }

  document.addEventListener("click", function (event) {
    const menu = document.getElementById("nav-menu");
    const hamburger = document.getElementById("hamburger");

    if (
      menu.classList.contains("open") &&
      !menu.contains(event.target) &&
      !hamburger.contains(event.target)
    ) {
      closeMenu();
    }
  });

  document.addEventListener("keydown", function (event) {
    if (event.key === "Escape") {
      closeMenu();
    }
  });
    
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    alert('Copied: ' + text);
  }, function(err) {
    alert('Failed to copy: ' + err);
  });
}
</script>

</body>
</html>


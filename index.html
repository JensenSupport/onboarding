<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Jensen Tire & Auto Onboarding</title>
  <link rel="stylesheet" href="shared-style.css" />
  <style>
    .hidden { display: none; }
    .card { background:#fff; border-radius:12px; padding:1rem; box-shadow:0 4px 10px rgba(0,0,0,.08); max-width:720px; margin:1rem auto; }
    .stack > * { margin-bottom:.75rem; }
    input, button { padding:.6rem .8rem; }
    pre { background:#f6f6f6; padding:.75rem; border-radius:8px; overflow:auto; }
    .muted { color:#666; font-size:.9rem; }
  </style>
</head>
<body>

<header>
  <img src="logo.jpg" alt="Jensen Tire & Auto Logo">
</header>

<div class="snap-container">
  <section id="onboarding">
    <div class="container">
      <h1>Welcome to Jensen Tire & Auto Onboarding</h1>
      <p class="subheading">Sign in with your company username. We’ll send you to the correct store and role.</p>

      <!-- LOGIN -->
      <div class="card stack" id="login-card">
        <label class="muted">Username</label>
        <input id="username" placeholder="e.g. bmiller" autocomplete="username">
        <label class="muted">Password</label>
        <input id="password" type="password" placeholder="••••••••" autocomplete="current-password">
        <div>
          <button id="signIn">Sign in</button>
        </div>
        <p class="muted">Need access or forgot your password? Contact
          <a href="mailto:support@jensentireandauto.com">Jensen Support</a>.
        </p>
        <pre id="status" class="hidden"></pre>
      </div>

      <footer>
        FAQs below. Further questions? Contact
        <a href="mailto:support@jensentireandauto.com">Jensen Support</a>
      </footer>
    </div>
  </section>
</div>

<section id="details" class="tall-section">
  <div class="container accordion">
    <h2>New Hire FAQ</h2>
    <div class="accordion-item">
      <button onclick="toggleAccordion(this)">Do I have login information already?</button>
      <div class="accordion-content">Your manager or IT will provide a username and temporary password. Sign in above.</div>
    </div>
    <div class="accordion-item">
      <button onclick="toggleAccordion(this)">How do I access training materials?</button>
      <div class="accordion-content">After sign-in, you’ll be routed to your store’s role-specific hub.</div>
    </div>
    <div class="accordion-item">
      <button onclick="toggleAccordion(this)">Who do I contact with issues?</button>
      <div class="accordion-content">Reach out to Jensen Support at support@jensentireandauto.com.</div>
    </div>
  </div>

  <div class="container feedback-section">
    <h1>We value your input!</h1>
    <form id="feedback-form">
      <textarea id="feedback" name="feedback" placeholder="Leave your feedback here..."></textarea>
      <br />
      <button type="submit" class="button">Submit</button>
    </form>
    <p id="thank-you" style="display:none; color:white; margin-top:20px;">Thank you for your feedback!</p>
  </div>

  <div class="quote-footer">
    <p class="quote">“Anyone who stops learning is old, whether at twenty or eighty. Anyone who keeps learning stays young.”</p>
    <p class="quote-author">– Henry Ford</p>
  </div>
</section>

<!-- Helpers -->
<script>
  function toggleAccordion(button) {
    const content = button.nextElementSibling;
    const isOpen = content.style.display === 'block';
    document.querySelectorAll('.accordion-content').forEach(el => el.style.display = 'none');
    if (!isOpen) content.style.display = 'block';
  }
</script>

<!-- Feedback form (unchanged) -->
<script>
  document.getElementById("feedback-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const feedback = document.getElementById("feedback").value;

    const response = await fetch("https://default4e006550b51242c29ec2b301c0fa6a.51.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/5a8c354b3a634ab893a5879f150f715d/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Jr-fRt0XwxxcfPUPvbpjS-xwfZlb2rjb4J_L2xwhXFg", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ feedback })
    });

    if (response.ok) {
      alert("Thank you for your feedback!");
      document.getElementById("feedback").value = "";
    } else {
      alert("Submission failed. Please try again.");
    }
  });
</script>

<!-- Firebase (modular CDN) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ===== 1) YOUR FIREBASE CONFIG =====
  const firebaseConfig = {
    apiKey: "AIzaSyC3clH2uoqhgqeEwj-uOlsNT5XTZHsI2W0",
    authDomain: "user-creds.firebaseapp.com",
    projectId: "user-creds",
    appId: "1:253655292974:web:f066f853ef2f3dd7f5d3bf"
  };

  // ===== 2) SETTINGS =====
  const FAKE_DOMAIN = "jta.local"; // the domain you used when creating users (username@jta.local)

  // ===== 3) INIT =====
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // UI helpers
  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  function showStatus(obj) {
    statusEl.classList.remove("hidden");
    statusEl.textContent = JSON.stringify(obj, null, 2);
  }

  // Sign in with username + password (mapped to username@FAKE_DOMAIN)
  $("signIn").onclick = async () => {
    const uname = $("username").value.trim().toLowerCase();
    const pw = $("password").value;
    if (!uname || !pw) return showStatus({ error: "Enter username and password." });
    try {
      const email = `${uname}@${FAKE_DOMAIN}`;
      await signInWithEmailAndPassword(auth, email, pw);
      // onAuthStateChanged will handle the rest
    } catch (e) {
      showStatus({ error: e.message });
    }
  };

  // After sign-in: read directory entry and route
  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    try {
      const email = (user.email || "").toLowerCase(); // e.g., bmiller@jta.local
      const dirRef = doc(db, "directory", email);
      const dirSnap = await getDoc(dirRef);

      if (!dirSnap.exists()) {
        await signOut(auth);
        return showStatus({ error: "No assignment found for your username. Contact support." });
      }

      // Ensure a per-user profile (optional)
      const profRef = doc(db, "profiles", user.uid);
      const profSnap = await getDoc(profRef);
      if (!profSnap.exists()) {
        await setDoc(profRef, {
          fakeEmail: email,
          createdAt: new Date().toISOString()
        }, { merge: true });
      }

      const { storeNumber, role } = dirSnap.data();
      if (!storeNumber || !role) {
        await signOut(auth);
        return showStatus({ error: "Your directory entry is incomplete. Contact support." });
      }

      // Route to {Store XX}/{manager.html|technician.html} (relative path works on GitHub Pages)
      const storeFolder = encodeURIComponent(storeNumber); // handles spaces in folder names
      const rolePage = (role === "Manager") ? "manager.html" : "technician.html";
      const dest = `${storeFolder}/${rolePage}`;
      window.location.href = dest;

    } catch (e) {
      showStatus({ error: e.message });
    }
  });
</script>

</body>
</html>
